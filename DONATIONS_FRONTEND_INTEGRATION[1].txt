INTEGRACIÓN FRONTEND - MÓDULO DE DONACIONES
Proyecto: Recetas-Del-Mundo
Fecha: 19-11-2025

Resumen
-------
Este documento describe en detalle los endpoints que el frontend debe usar para el flujo de donaciones con Stripe y para validación/verificación de transacciones. Incluye headers requeridos, formato de body, ejemplos (PowerShell/cURL), manejo de errores, comportamiento cuando Stripe no está configurado y pasos para pruebas locales (Stripe CLI).

Autenticación
-------------
- Todos los endpoints que realizan cambios o devuelven datos sensibles requieren el header:
  Authorization: Bearer <JWT>
- El JWT se verifica con `JwtUtil.extractUserId` y se usa para asociar la donación al usuario. El token debe ser válido.

Variables de entorno necesarias (backend)
--------------------------------------
- STRIPE_SECRET_KEY : clave secreta de Stripe (obligatoria para llamar a Stripe API desde el backend).
- STRIPE_WEBHOOK_SECRET : secreto del webhook para validar firmas de Stripe (recomendado en produccion).
- DONATION_SUCCESS_URL / DONATION_CANCEL_URL : URLs de retorno usadas al crear la Checkout Session.

Endpoints (detallado)
---------------------

1) Crear sesión de Checkout (crear donación) — create-session
   ---------------------------------------------------------
   - Método: POST
   - URL: /donaciones/create-session
   - Headers:
     - Authorization: Bearer <JWT>
     - Content-Type: application/json
   - Body JSON esperado:
     {
       "amount": 500,        // entero, cents (ej: 500 = $5.00)
       "idReceta": 21,       // opcional, entero
       "currency": "usd"   // opcional, por defecto "usd"
     }
   - Comportamiento:
     1. El backend crea primero una fila en la tabla `donacion` con status = "PENDING".
     2. Si `STRIPE_SECRET_KEY` está configurada, el backend crea una Stripe Checkout Session, guarda `stripe_session_id` en `donacion` y crea una fila `sesion_pago` con provider="stripe" y status="PENDING".
     3. Si `STRIPE_SECRET_KEY` NO está configurada, el backend crea una fila `sesion_pago` local con session_id = "local:donacion:<id>" y devuelve una respuesta con la Donacion (PENDING) y el registro sesion_pago.
   - Respuestas:
     - 201 Created (caso normal)
       - Si STRIPE configurado: { "sessionId": "cs_...", "url": "https://checkout.stripe.com/...", "donacion": {...} }
       - Si STRIPE no configurado: { "donacion": {...}, "sesion_pago": {...}, "note": "..." }
     - 400 Bad Request: payload inválido (ej: amount faltante o <= 0)
     - 401 Unauthorized: token faltante o inválido
     - 500 Internal Server Error: error con Stripe o servidor

   - Ejemplo PowerShell (sin Stripe configurado aún):
     $token = '<JWT>'
     $hdr = @{ Authorization = "Bearer $token"; 'Content-Type' = 'application/json' }
     $body = @{ amount = 500; idReceta = 21 } | ConvertTo-Json
     Invoke-RestMethod -Method Post -Uri 'http://localhost:8081/donaciones/create-session' -Headers $hdr -Body $body


2) Verificar sesión con Stripe (frontend -> backend -> Stripe)
   --------------------------------------------------------------
   - Método: POST
   - URL: /donaciones/verify-session
   - Headers:
     - Authorization: Bearer <JWT>
     - Content-Type: application/json
   - Body JSON esperado:
     { "sessionId": "cs_XXXX" }
   - Propósito: el frontend, tras completar la redirección de Stripe, llama a este endpoint para que el backend consulte a Stripe la sesión (usando STRIPE_SECRET_KEY), obtenga el estado de la transacción y devuelva al frontend los datos relevantes; además el backend actualizará/creará los registros en `donacion` y `sesion_pago`.
   - Comportamiento:
     1. El backend llama a Stripe: Session.retrieve(sessionId).
     2. Obtiene estado de pago (payment_status / payment_intent / amount / currency / metadata).
     3. Busca Donacion por stripe_session_id o por metadata.donacion_id; si existe, la actualiza (stripe_payment_intent y status=PAID si corresponde).
     4. Si no existe, crea una Donacion fallback (asociada al usuario) con la información disponible.
     5. Actualiza o crea la fila `sesion_pago` correspondiente con status = PAID/PENDING según Stripe.
     6. Devuelve JSON con { session, donacion, sesion_pago } para que el frontend lo muestre/consuma.
   - Respuestas:
     - 200 OK: { session, donacion, sesion_pago }
     - 400 Bad Request: falta sessionId o STRIPE_SECRET_KEY no configurada
     - 401 Unauthorized: token faltante/ inválido
     - 403 Forbidden: la donación encontrada no pertenece al usuario autenticado
     - 500 Internal Server Error: error desde Stripe u otro fallo

   - Ejemplo PowerShell:
     $token = '<JWT>'
     $hdr = @{ Authorization = "Bearer $token"; 'Content-Type' = 'application/json' }
     $body = @{ sessionId = 'cs_test_12345' } | ConvertTo-Json
     Invoke-RestMethod -Method Post -Uri 'http://localhost:8081/donaciones/verify-session' -Headers $hdr -Body $body


3) Webhook de Stripe — notificación de eventos
   ---------------------------------------------
   - Método: POST
   - URL: /webhook/stripe
   - Uso: Stripe llama a este endpoint al ocurrir eventos (por ejemplo checkout.session.completed). El backend valida la firma con STRIPE_WEBHOOK_SECRET si está configurado; si no, intenta parsear el evento sin verificación (solo para desarrollo local).
   - Comportamiento importante:
     - Para eventos `checkout.session.completed` el backend:
       * Deserializa la Session.
       * Busca Donacion por stripe_session_id.
       * Si la encuentra: setStatus("PAID"), setStripePaymentIntent(...), guardar.
       * Si no la encuentra: busca metadata.donacion_id y asocia/actualiza la Donacion. Si es necesario crea/actualiza el registro `sesion_pago` también.
     - Responde 200 "received" si procesó correctamente.
   - Configuración y pruebas locales (Stripe CLI):
     1. Instalar Stripe CLI (https://stripe.com/docs/stripe-cli).
     2. Correr en una terminal: stripe listen --forward-to http://localhost:8081/webhook/stripe
     3. Generar eventos de prueba: stripe trigger checkout.session.completed
   - Seguridad: en producción configure STRIPE_WEBHOOK_SECRET y mantenga el endpoint firmado.


Consideraciones y casos especiales
---------------------------------
- session_id local: cuando no hay STRIPE_SECRET_KEY, el backend creará session_id tipo "local:donacion:<id>" y un registro en `sesion_pago` para rastrear la intención de pago.
- Propiedad/Seguridad: el endpoint `/donaciones/verify-session` verifica que la donación encontrada pertenece al usuario autenticado (si la donacion tiene idUsr). Si no, devuelve 403.
- Fallbacks: si no existe donacion ni metadata.donacion_id, el backend crea una Donacion fallback asociada al usuario que solicita la verificación (evita pérdida de información).
- Metadata: cuando se crea la Checkout Session se almacena metadata.donacion_id = <idDonacion>; el webhook y verify-session utilizan ese campo.

Consultas SQL útiles (para QA / verificaciones rápidas)
------------------------------------------------------
- Últimas donaciones:
  SELECT id_donacion, id_usr, amount, currency, status, stripe_session_id, stripe_payment_intent, fecha_creacion
  FROM donacion
  ORDER BY fecha_creacion DESC
  LIMIT 10;

- Últimas sesiones de pago:
  SELECT id_sesion, session_id, provider, status, id_donacion, metadata, fecha_creacion
  FROM sesion_pago
  ORDER BY fecha_creacion DESC
  LIMIT 10;

Recomendaciones para el frontend (UX)
------------------------------------
- Después de crear la sesión (respuesta con session.url): redirigir al usuario a `session.url` para completar el pago.
- En la página de retorno (success URL), en lugar de fiarse solo del querystring de Stripe, llamar a `/donaciones/verify-session` con el sessionId recibido (la checkout session incluye `?session_id={CHECKOUT_SESSION_ID}` en el success URL). Mostrar un estado de confirmación al usuario basado en la respuesta del backend.
- Manejar errores: si la respuesta indica que la donación no pertenece al usuario (403) mostrar mensaje apropiado y solicitar reintento o contacto con soporte.

Depuración / logs
-----------------
- Habilitar logs en backend para los controladores `StripeDonacionController` y `StripeWebhookController` ayuda mucho para depurar discrepancias entre lo que devuelve Stripe y lo que hay en la BD.
