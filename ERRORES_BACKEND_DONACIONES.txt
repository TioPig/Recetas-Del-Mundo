================================================================================
  ERRORES EN ENDPOINT /donaciones/verify-session
================================================================================

Fecha: 21 de Noviembre, 2025
Servidor: root@168.181.187.137
Contenedor: api-recetas-backend
Endpoint afectado: POST /donaciones/verify-session


================================================================================
  ERROR #1: TIPO DE DATO JSONB INCORRECTO
================================================================================

ğŸ”´ SEVERIDAD: CRÃTICA

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
MENSAJE DE ERROR:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

org.postgresql.util.PSQLException: ERROR: column "metadata" is of type jsonb 
but expression is of type character varying

Hint: You will need to rewrite or cast the expression.
Position: 160


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
UBICACIÃ“N:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Archivo: StripeDonacionController.java:305
OperaciÃ³n: INSERT INTO tabla sesion_pago

Query SQL:

INSERT INTO sesion_pago 
  (session_id, provider, status, id_donacion, fecha_creacion, 
   fecha_actualizacion, metadata) 
VALUES 
  (?, 'stripe', ?, ?, now(), now(), ?)


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EXPLICACIÃ“N:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

La columna 'metadata' en la tabla sesion_pago de PostgreSQL estÃ¡ definida 
como tipo JSONB (un tipo de dato binario para JSON en PostgreSQL).

El cÃ³digo Java estÃ¡ intentando insertar un valor de tipo String (VARCHAR) 
en esa columna.

PostgreSQL es estricto con los tipos de datos y NO convierte automÃ¡ticamente 
un String a JSONB. El valor debe ser:
  - ExplÃ­citamente casteado con ::jsonb
  - Convertido usando funciones como to_jsonb()
  - O enviado como tipo PGobject desde Java

Este error impide que se guarde el registro de la sesiÃ³n de pago en la 
base de datos.


================================================================================
  ERROR #2: SERIALIZACIÃ“N DE STRIPE SESSION
================================================================================

ğŸ”´ SEVERIDAD: CRÃTICA

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
MENSAJE DE ERROR:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

org.springframework.http.converter.HttpMessageConversionException: 
Type definition error: [simple type, class com.google.gson.JsonObject]

Failed to complete request


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
UBICACIÃ“N:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Archivo: StripeDonacionController.java (mÃ©todo verifySession)
OperaciÃ³n: return ResponseEntity.ok(...)

CÃ³digo problemÃ¡tico:

return ResponseEntity.ok(Map.of(
    "donacion", donacion,
    "session", session      // âŒ Este objeto causa el error
));


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EXPLICACIÃ“N:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

El endpoint intenta devolver el objeto completo 'session' de tipo 
com.stripe.model.checkout.Session en la respuesta JSON.

Este objeto de Stripe usa internamente la librerÃ­a Gson (com.google.gson) 
para manejar JSON y contiene objetos de tipo JsonObject.

Spring Boot usa Jackson como su serializador JSON por defecto, y Jackson 
NO puede serializar automÃ¡ticamente objetos Gson.

Conflicto de librerÃ­as:
  - Stripe Java SDK usa: Gson (com.google.gson.JsonObject)
  - Spring Boot usa: Jackson (com.fasterxml.jackson)

Cuando Spring intenta convertir el objeto a JSON para la respuesta HTTP, 
Jackson encuentra objetos JsonObject de Gson que no sabe cÃ³mo serializar, 
provocando la excepciÃ³n.

Este error impide que el endpoint devuelva una respuesta vÃ¡lida al frontend,
resultando en un HTTP 500 Internal Server Error.


================================================================================
  ERROR #3: getOutputStream() YA FUE LLAMADO
================================================================================

ğŸŸ¡ SEVERIDAD: MEDIA (Error secundario causado por los anteriores)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
MENSAJE DE ERROR:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

java.lang.IllegalStateException: getOutputStream() has already been called 
for this response

at cl.duoc.api.filter.MethodAuthFilter.unauthorized(MethodAuthFilter.java:168)


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
UBICACIÃ“N:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Archivo: MethodAuthFilter.java:168
OperaciÃ³n: Intentando escribir respuesta de error


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EXPLICACIÃ“N:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Este es un error EN CASCADA provocado por los Errores #1 y #2.

Flujo del error:

1. El controller intenta devolver la respuesta con el objeto Stripe
2. Jackson falla al intentar serializar â†’ lanza excepciÃ³n
3. Spring maneja la excepciÃ³n internamente â†’ escribe al OutputStream
4. El filtro MethodAuthFilter detecta el error y tambiÃ©n intenta escribir 
   una respuesta de error
5. Cuando el filtro llama a response.getWriter(), HttpServletResponse 
   detecta que ya se usÃ³ getOutputStream() previamente
6. Se lanza IllegalStateException porque no se pueden usar ambos mÃ©todos 
   (getWriter y getOutputStream) en la misma respuesta HTTP

En HTTP servlet API:
  - getOutputStream() â†’ para datos binarios
  - getWriter() â†’ para texto
  - Solo se puede usar UNO de los dos en cada respuesta

Este error NO es el problema real, sino una consecuencia de que el manejo 
de errores estÃ¡ intentando escribir dos veces a la respuesta HTTP.


================================================================================
  FLUJO COMPLETO DEL ERROR
================================================================================

1. Frontend envÃ­a: POST /donaciones/verify-session âœ…
   â”œâ”€ Body: { "sessionId": "cs_test_a1yWfq..." }
   â””â”€ Header: Authorization: "Bearer <token>"

2. Backend autentica la peticiÃ³n âœ…
   â””â”€ Token vÃ¡lido

3. Backend consulta Stripe API âœ…
   â””â”€ Obtiene session con paymentStatus: "paid"

4. Backend busca donaciÃ³n en base de datos âœ…
   â””â”€ Encuentra registro de donaciÃ³n

5. Backend intenta INSERT en sesion_pago âŒ ERROR #1
   â””â”€ metadata es String pero columna es JSONB
   â””â”€ PostgreSQL rechaza el INSERT
   â””â”€ Log: "[StripeDonacionController] direct SQL upsert for sesion_pago failed"
   â””â”€ El cÃ³digo continÃºa (try-catch)

6. Backend intenta devolver respuesta âŒ ERROR #2
   â””â”€ return Map.of("donacion", donacion, "session", session)
   â””â”€ Jackson intenta serializar com.stripe.model.checkout.Session
   â””â”€ Encuentra objetos Gson que no puede convertir
   â””â”€ Lanza HttpMessageConversionException

7. Spring maneja la excepciÃ³n
   â””â”€ Escribe error 500 al response.getOutputStream()

8. MethodAuthFilter intenta escribir su propio error âŒ ERROR #3
   â””â”€ Llama a response.getWriter()
   â””â”€ IllegalStateException: OutputStream ya fue usado

9. Cliente recibe:
   â””â”€ HTTP 500 Internal Server Error
   â””â”€ Body: { "timestamp": "...", "status": 500, "error": "Internal Server Error" }


================================================================================
  IMPACTO EN LA APLICACIÃ“N
================================================================================

Frontend:
  - Usuario completa pago en Stripe âœ…
  - Stripe redirige a /donacion/success?session_id=... âœ…
  - Frontend llama a POST /donaciones/verify-session âŒ
  - Endpoint devuelve HTTP 500
  - Frontend usa sessionStorage como fallback
  - Se muestra monto correcto PERO no se confirma desde base de datos

Backend:
  - El pago SÃ fue procesado por Stripe âœ…
  - El registro de donaciÃ³n SÃ existe en tabla 'donacion' âœ…
  - El registro de sesion_pago NO se guarda âŒ
  - No se puede verificar el pago desde la base de datos âŒ

Base de datos:
  - Tabla 'donacion': Contiene el registro âœ…
  - Tabla 'sesion_pago': NO contiene el registro âŒ
  - Falta la relaciÃ³n entre donaciÃ³n y sesiÃ³n de Stripe


================================================================================
  ARCHIVOS AFECTADOS
================================================================================

ğŸ“ backend/src/main/java/cl/duoc/api/controller/
   â””â”€ StripeDonacionController.java
      â”œâ”€ LÃ­nea ~305: INSERT con metadata sin cast
      â””â”€ MÃ©todo verifySession: return con objeto Stripe completo

ğŸ“ backend/src/main/java/cl/duoc/api/filter/
   â””â”€ MethodAuthFilter.java
      â””â”€ LÃ­nea 168: MÃ©todo unauthorized() intenta escribir despuÃ©s de error


Ãšltima actualizaciÃ³n: 21 de Noviembre, 2025
================================================================================
